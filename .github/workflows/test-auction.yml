name: Run Auction CLI

permissions:
  contents: read

on:
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      epoch_start:
        description: 'Start epoch (leave empty for latest only)'
        required: false
        default: ''
      epoch_end:
        description: 'End epoch (leave empty for single epoch or latest)'
        required: false
        default: ''

env:
  DATA_REPO: marinade-finance/ds-sam-pipeline
  DATA_BRANCH: main
  AUCTIONS_PATH: auctions

jobs:
  run-auction-cli:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: ğŸƒâ€â™‚ï¸ Checkout project
        uses: actions/checkout@v4

      - name: ğŸ‘©â€ğŸ”§ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: ğŸ‘¨â€ğŸ”§ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ‹ï¸ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build project
        run: pnpm -r build

      - name: ğŸ“¥ Get latest data repo commit hash
        id: data-hash
        run: |
          HASH=$(git ls-remote https://github.com/${{ env.DATA_REPO }}.git refs/heads/${{ env.DATA_BRANCH }} | cut -f1)
          echo "hash=${HASH}" >> $GITHUB_OUTPUT
          echo "Data repo commit: ${HASH}"

      - name: ğŸ’¾ Cache auction data
        id: cache-auctions
        uses: actions/cache@v4
        with:
          path: data-repo/auctions
          key: auction-data-${{ steps.data-hash.outputs.hash }}
          restore-keys: |
            auction-data-

      - name: ğŸ“¦ Fetch auction data (sparse checkout)
        if: steps.cache-auctions.outputs.cache-hit != 'true'
        run: |
          mkdir -p data-repo
          cd data-repo
          git init
          git remote add origin https://github.com/${{ env.DATA_REPO }}.git
          git config core.sparseCheckout true
          echo "${{ env.AUCTIONS_PATH }}/" >> .git/info/sparse-checkout
          git fetch --depth 1 origin ${{ env.DATA_BRANCH }}
          git checkout FETCH_HEAD
          echo "âœ… Fetched auction data"
          ls -la "${{ env.AUCTIONS_PATH }}/" | head -10

      - name: ğŸ” Determine epochs to process
        id: epochs
        run: |
          AUCTIONS_DIR="data-repo/auctions"

          get_epoch_folders() {
            ls -1 "$AUCTIONS_DIR" | grep -E '^[0-9]+\.' | sort -t. -k1,1n
          }

          get_epoch_num() {
            echo "$1" | cut -d. -f1
          }

          EPOCH_START="${{ github.event.inputs.epoch_start }}"
          EPOCH_END="${{ github.event.inputs.epoch_end }}"

          if [ -z "$EPOCH_START" ] && [ -z "$EPOCH_END" ]; then
            LATEST_FOLDER=$(get_epoch_folders | tail -1)
            echo "folders=${LATEST_FOLDER}" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ Running on latest epoch: ${LATEST_FOLDER}"
          else
            FOLDERS=""
            for folder in $(get_epoch_folders); do
              epoch_num=$(get_epoch_num "$folder")
              if [ -n "$EPOCH_START" ] && [ "$epoch_num" -lt "$EPOCH_START" ]; then
                continue
              fi
              if [ -n "$EPOCH_END" ] && [ "$epoch_num" -gt "$EPOCH_END" ]; then
                continue
              fi
              if [ -z "$FOLDERS" ]; then
                FOLDERS="$folder"
              else
                FOLDERS="${FOLDERS} ${folder}"
              fi
            done
            echo "folders=${FOLDERS}" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ Running on epochs: ${FOLDERS}"
          fi

      - name: ğŸš€ Run auction CLI
        id: run-cli
        run: |
          AUCTIONS_DIR="data-repo/auctions"
          OUTPUTS_BASE="outputs"
          mkdir -p "$OUTPUTS_BASE"

          FOLDERS="${{ steps.epochs.outputs.folders }}"
          FAILED=0
          PROCESSED=0
          PROCESSED_FOLDERS=""

          for folder in $FOLDERS; do
            inputs_dir="${AUCTIONS_DIR}/${folder}/inputs"
            outputs_dir="${OUTPUTS_BASE}/out/${folder}"
            log_file="${OUTPUTS_BASE}/${folder}.log"
            
            echo "=============================================="
            echo "ğŸ“‚ Processing: $folder"
            echo "   Inputs:  $inputs_dir"
            echo "   Outputs: $outputs_dir"
            echo "=============================================="
            
            if [ ! -d "$inputs_dir" ]; then
              echo "âš ï¸  Inputs directory not found, skipping"
              continue
            fi
            
            mkdir -p "$outputs_dir"
            
            if pnpm run cli -- auction \
              --inputs-source FILES \
              --cache-dir-path "$inputs_dir" \
              -c "${inputs_dir}/config.json" \
              -o "$outputs_dir" > "$log_file" 2>&1; then
              echo "âœ… Success: $folder"
              PROCESSED=$((PROCESSED + 1))
              # Track successfully processed folders for diffing
              if [ -z "$PROCESSED_FOLDERS" ]; then
                PROCESSED_FOLDERS="$folder"
              else
                PROCESSED_FOLDERS="${PROCESSED_FOLDERS} ${folder}"
              fi
            else
              echo "âŒ Failed: $folder"
              FAILED=$((FAILED + 1))
            fi
          done

          echo "processed=${PROCESSED}" >> $GITHUB_OUTPUT
          echo "failed=${FAILED}" >> $GITHUB_OUTPUT
          echo "processed_folders=${PROCESSED_FOLDERS}" >> $GITHUB_OUTPUT

          echo "=============================================="
          echo "ğŸ“Š Summary: Processed=$PROCESSED, Failed=$FAILED"
          echo "=============================================="

          if [ "$FAILED" -gt 0 ]; then
            exit 42
          fi

      - name: ğŸ”¬ Run diffs against original outputs
        if: steps.run-cli.outputs.processed != '0'
        run: |
          AUCTIONS_DIR="data-repo/auctions"
          OUTPUTS_BASE="outputs/out"
          DIFFS_DIR="diffs"
          mkdir -p "$DIFFS_DIR"

          PROCESSED_FOLDERS="${{ steps.run-cli.outputs.processed_folders }}"

          # Function to extract stake data
          extract_stakes() {
            local input="$1"
            local output="$2"
            jq -r '[.auctionData.validators[] | select(.auctionStake.marinadeSamTargetSol > 0)] |
              sort_by(.voteAccount) | .[] |
              "\(.voteAccount): \(.auctionStake.marinadeSamTargetSol)"' "$input" > "$output"
          }

          # Function to extract bidTooLow penalties
          extract_bid_too_low() {
            local input="$1"
            local output="$2"
            jq -r '.auctionData.validators[] |
              select(.revShare.bidTooLowPenaltyPmpe > 0) |
              "\(.voteAccount): \(.revShare.bidTooLowPenaltyPmpe)"' "$input" | sort > "$output"
          }

          for folder in $PROCESSED_FOLDERS; do
            echo "=============================================="
            echo "ğŸ”¬ Diffing: $folder"
            echo "=============================================="

            new_dir="${OUTPUTS_BASE}/${folder}"
            orig_dir="${AUCTIONS_DIR}/${folder}/outputs"
            diff_out="${DIFFS_DIR}/${folder}"
            mkdir -p "$diff_out"

            # Initialize diff report
            report="${diff_out}/diff-report.md"
            echo "# Diff Report for Epoch ${folder}" > "$report"
            echo "" >> "$report"
            echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$report"
            echo "" >> "$report"

            # --- summary.md diff ---
            echo "## summary.md" >> "$report"
            if [ -f "$new_dir/summary.md" ] && [ -f "$orig_dir/summary.md" ]; then
              if diff -u "$orig_dir/summary.md" "$new_dir/summary.md" > "$diff_out/summary.diff" 2>&1; then
                echo "âœ… summary.md: identical"
                echo "âœ… No differences" >> "$report"
              else
                echo "âš ï¸  summary.md: differences found"
                echo '```diff' >> "$report"
                head -100 "$diff_out/summary.diff" >> "$report"
                echo '```' >> "$report"
              fi
            else
              echo "âš ï¸  summary.md: missing file(s)"
              echo "âš ï¸ Missing file(s)" >> "$report"
            fi
            echo "" >> "$report"

            # --- results.json diff ---
            echo "## results.json" >> "$report"
            if [ -f "$new_dir/results.json" ] && [ -f "$orig_dir/results.json" ]; then
              if diff -u "$orig_dir/results.json" "$new_dir/results.json" > "$diff_out/results.diff" 2>&1; then
                echo "âœ… results.json: identical"
                echo "âœ… No differences" >> "$report"
              else
                DIFF_LINES=$(wc -l < "$diff_out/results.diff")
                echo "âš ï¸  results.json: ${DIFF_LINES} diff lines"
                echo "âš ï¸ ${DIFF_LINES} diff lines (see results.diff)" >> "$report"
              fi
            else
              echo "âš ï¸  results.json: missing file(s)"
              echo "âš ï¸ Missing file(s)" >> "$report"
            fi
            echo "" >> "$report"

            # --- Stake comparison ---
            echo "## Stake Allocation" >> "$report"
            if [ -f "$new_dir/results.json" ] && [ -f "$orig_dir/results.json" ]; then
              extract_stakes "$new_dir/results.json" "$diff_out/new-stakes.txt"
              extract_stakes "$orig_dir/results.json" "$diff_out/orig-stakes.txt"

              new_total=$(cut -d':' -f2 "$diff_out/new-stakes.txt" | paste -sd+ | bc 2>/dev/null || echo "0")
              orig_total=$(cut -d':' -f2 "$diff_out/orig-stakes.txt" | paste -sd+ | bc 2>/dev/null || echo "0")

              echo "| Source | Total Stake |" >> "$report"
              echo "|--------|-------------|" >> "$report"
              echo "| Original | ${orig_total} |" >> "$report"
              echo "| New | ${new_total} |" >> "$report"
              echo "" >> "$report"

              echo "   Original total stake: $orig_total"
              echo "   New total stake:      $new_total"

              if diff -u "$diff_out/orig-stakes.txt" "$diff_out/new-stakes.txt" > "$diff_out/stakes.diff" 2>&1; then
                echo "âœ… Stakes: identical"
                echo "âœ… Stake allocations identical" >> "$report"
              else
                STAKE_CHANGES=$(grep -c '^[-+]' "$diff_out/stakes.diff" || echo "0")
                echo "âš ï¸  Stakes: ${STAKE_CHANGES} changes"
                echo "âš ï¸ ${STAKE_CHANGES} stake changes (see stakes.diff)" >> "$report"
              fi
            fi
            echo "" >> "$report"

            # --- bidTooLow penalties ---
            echo "## Bid Too Low Penalties" >> "$report"
            if [ -f "$new_dir/results.json" ] && [ -f "$orig_dir/results.json" ]; then
              extract_bid_too_low "$new_dir/results.json" "$diff_out/new-bidTooLow.txt"
              extract_bid_too_low "$orig_dir/results.json" "$diff_out/orig-bidTooLow.txt"

              if diff -u "$diff_out/orig-bidTooLow.txt" "$diff_out/new-bidTooLow.txt" > "$diff_out/bidTooLow.diff" 2>&1; then
                echo "âœ… bidTooLow: identical"
                echo "âœ… No differences" >> "$report"
              else
                echo "âš ï¸  bidTooLow: differences found"
                echo '```diff' >> "$report"
                cat "$diff_out/bidTooLow.diff" >> "$report"
                echo '```' >> "$report"
              fi
            fi

            echo ""
            echo "ğŸ“„ Report saved: $report"
          done

          echo "=============================================="
          echo "âœ… All diffs completed"
          echo "=============================================="

      - name: ğŸ“ğŸ“ Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: auction-results-${{ github.run_id }}
          path: outputs/out/
          if-no-files-found: warn
          retention-days: 15

      - name: ğŸ“âœï¸ Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: auction-logs-${{ github.run_id }}
          path: outputs/*.log
          if-no-files-found: warn
          retention-days: 3

      - name: ğŸ“ğŸ”¬ Upload diffs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: auction-diffs-${{ github.run_id }}
          path: diffs/
          if-no-files-found: warn
          retention-days: 15
