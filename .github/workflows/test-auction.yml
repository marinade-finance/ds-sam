name: Run Auction CLI

permissions:
  contents: read

on:
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      epoch_start:
        description: 'Start epoch (leave empty for latest only)'
        required: false
        default: ''
      epoch_end:
        description: 'End epoch (leave empty for single epoch or latest)'
        required: false
        default: ''

env:
  DATA_REPO: marinade-finance/ds-sam-pipeline
  DATA_BRANCH: main
  AUCTIONS_PATH: auctions

jobs:
  run-auction-cli:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: ğŸƒâ€â™‚ï¸ Checkout project
        uses: actions/checkout@v4

      - name: ğŸ‘©â€ğŸ”§ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: ğŸ‘¨â€ğŸ”§ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¥ Get latest data repo commit hash
        id: data-hash
        run: |
          HASH=$(git ls-remote https://github.com/${{ env.DATA_REPO }}.git refs/heads/${{ env.DATA_BRANCH }} | cut -f1)
          echo "hash=${HASH}" >> $GITHUB_OUTPUT
          echo "Data repo commit: ${HASH}"

      - name: ğŸ’¾ Cache auction data
        id: cache-auctions
        uses: actions/cache@v4
        with:
          path: data-repo/auctions
          key: auction-data-${{ steps.data-hash.outputs.hash }}
          restore-keys: |
            auction-data-

      - name: ğŸ“¦ Fetch auction data (sparse checkout)
        if: steps.cache-auctions.outputs.cache-hit != 'true'
        run: |
          mkdir -p data-repo
          cd data-repo
          git init
          git remote add origin https://github.com/${{ env.DATA_REPO }}.git
          git config core.sparseCheckout true
          echo "${{ env.AUCTIONS_PATH }}/" >> .git/info/sparse-checkout
          git fetch --depth 1 origin ${{ env.DATA_BRANCH }}
          git checkout FETCH_HEAD
          echo "âœ… Fetched auction data"
          ls -la "${{ env.AUCTIONS_PATH }}/" | head -10

      - name: ğŸš€ Run auction test script
        id: run-test
        run: |
          chmod +x scripts/run-auction-test.sh

          # Build arguments based on inputs
          ARGS="-d data-repo/auctions -o auction-test-output"
          if [ -n "${{ github.event.inputs.epoch_start }}" ]; then
            ARGS="$ARGS --epoch-start ${{ github.event.inputs.epoch_start }}"
          fi
          if [ -n "${{ github.event.inputs.epoch_end }}" ]; then
            ARGS="$ARGS --epoch-end ${{ github.event.inputs.epoch_end }}"
          fi
          if [ -z "${{ github.event.inputs.epoch_start }}" ] && [ -z "${{ github.event.inputs.epoch_end }}" ]; then
            ARGS="$ARGS --latest"
          fi

          # Run the script
          ./scripts/run-auction-test.sh $ARGS --verbose

      - name: ğŸ“ğŸ“ Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: auction-results-${{ github.run_id }}
          path: auction-test-output/outputs/out/
          if-no-files-found: warn
          retention-days: 15

      - name: ğŸ“âœï¸ Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: auction-logs-${{ github.run_id }}
          path: auction-test-output/outputs/*.log
          if-no-files-found: warn
          retention-days: 3

      - name: ğŸ“ğŸ”¬ Upload diffs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: auction-diffs-${{ github.run_id }}
          path: auction-test-output/diffs/
          if-no-files-found: warn
          retention-days: 15
